<!DOCTYPE html>

<html>
<head>
  <title>descendant.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>

      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">


                <a class="source" href="descendant.js.html">
                  descendant.js
                </a>


                <a class="source" href="index.js.html">
                  index.js
                </a>

            </div>
          </div>
        </li>
      </ul>

    <ul class="sections">

          <li id="title">
              <div class="annotation">
                  <h1>descendant.js</h1>
              </div>
          </li>



        <li id="section-1">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert'</span>)
<span class="hljs-keyword">const</span> events = <span class="hljs-built_in">require</span>(<span class="hljs-string">'events'</span>)

<span class="hljs-keyword">const</span> coalesce = <span class="hljs-built_in">require</span>(<span class="hljs-string">'extant'</span>)

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">send</span> (<span class="hljs-params">destination, vargs</span>) </span>{
    <span class="hljs-keyword">if</span> (vargs[<span class="hljs-number">1</span>] != <span class="hljs-literal">null</span>) {
        vargs.push(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>) </span>{
            <span class="hljs-keyword">if</span> (error) {
                vargs[<span class="hljs-number">1</span>].destroy()
            }
        })
    }
    <span class="hljs-keyword">if</span> (destination.connected) {
        destination.send.apply(destination, vargs)
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (vargs[<span class="hljs-number">1</span>] != <span class="hljs-literal">null</span>) {
        vargs[<span class="hljs-number">1</span>].destroy()
    }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">down</span> (<span class="hljs-params">descendant</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">message</span>) </span>{
        <span class="hljs-keyword">const</span> vargs = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>)
        <span class="hljs-keyword">if</span> (
            message.module == <span class="hljs-string">'descendant'</span> &amp;&amp;
            message.method == <span class="hljs-string">'route'</span> &amp;&amp;
            <span class="hljs-built_in">Array</span>.isArray(message.to) &amp;&amp;
            <span class="hljs-built_in">Array</span>.isArray(message.path)
        ) {
            message = <span class="hljs-built_in">JSON</span>.parse(<span class="hljs-built_in">JSON</span>.stringify(message))
            message.path.push(descendant.process.pid)
            <span class="hljs-keyword">if</span> (message.to.length == <span class="hljs-number">0</span>) {
                vargs[<span class="hljs-number">0</span>] = {
                    <span class="hljs-attr">module</span>: <span class="hljs-string">'descendant'</span>,
                    <span class="hljs-attr">method</span>: <span class="hljs-string">'route'</span>,
                    <span class="hljs-attr">name</span>: message.name,
                    <span class="hljs-attr">from</span>: message.from,
                    <span class="hljs-attr">to</span>: message.path,
                    <span class="hljs-attr">body</span>: message.body
                }
                vargs.unshift(message.name)
                descendant.emit.apply(descendant, vargs)
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">const</span> child = descendant.children[message.to[<span class="hljs-number">0</span>]]
                <span class="hljs-keyword">if</span> (child != <span class="hljs-literal">null</span>) {
                    message.to.shift()
                    vargs[<span class="hljs-number">0</span>] = message
                    send(child, vargs)
                }
            }
        } <span class="hljs-keyword">else</span> {</pre></div></div>

        </li>


        <li id="section-2">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>We’ve made <code>&quot;down&quot;</code> a wrapped message to be consistent with
<code>&quot;up&quot;</code>, even though we don’t really add any meaningful
information to the envelope.</p>

            </div>

            <div class="content"><div class='highlight'><pre>            vargs[<span class="hljs-number">0</span>] = {
                <span class="hljs-attr">module</span>: <span class="hljs-string">'descendant'</span>,
                <span class="hljs-attr">method</span>: <span class="hljs-string">'down'</span>,
                <span class="hljs-attr">body</span>: message
            }
            vargs.unshift(<span class="hljs-string">'down'</span>)
            descendant.emit.apply(descendant, vargs)
        }
    }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">up</span> (<span class="hljs-params">descendant, cookie, pid</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">message</span>) </span>{
        <span class="hljs-keyword">const</span> vargs = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>)
        <span class="hljs-keyword">if</span> (
            message.module == <span class="hljs-string">'descendant'</span> &amp;&amp;
            message.method == <span class="hljs-string">'route'</span> &amp;&amp;
            <span class="hljs-built_in">Array</span>.isArray(message.to) &amp;&amp;
            <span class="hljs-built_in">Array</span>.isArray(message.path)
        ) {
            message = <span class="hljs-built_in">JSON</span>.parse(<span class="hljs-built_in">JSON</span>.stringify(message))
            <span class="hljs-keyword">if</span> (message.path.length == <span class="hljs-number">1</span>) {
                message.cookie = coalesce(cookie)
            }</pre></div></div>

        </li>


        <li id="section-3">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Was using zero to mean go to the root, but that doesn’t mean
anything because we could be running underneath a Node.js
supervisor of some sort that enabled <code>&#39;ipc&#39;</code>, so is that
anonymous process the root? We should always specify a PID for
the destination, which can be set in an environment variable. We
could visit everyone on the way up, but if we have a handle and a
visitor consumes it, but then we propagate it, then the visitor
loses the handle. Well, we could assert that if we’re going up
with <code>0</code> that no handle is passed, so we could revisit this.</p>

            </div>

            <div class="content"><div class='highlight'><pre>            message.path.unshift(descendant.process.pid)
            <span class="hljs-keyword">if</span> (
                message.to[<span class="hljs-number">0</span>] === descendant.process.pid ||
                message.to[<span class="hljs-number">0</span>] === <span class="hljs-number">0</span>
            ) {</pre></div></div>

        </li>


        <li id="section-4">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>TODO What sort of path information do you add to a
redirect?</p>

            </div>

            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (message.to.length == <span class="hljs-number">1</span>) {
                    vargs[<span class="hljs-number">0</span>] = {
                        <span class="hljs-attr">module</span>: <span class="hljs-string">'descendant'</span>,
                        <span class="hljs-attr">method</span>: <span class="hljs-string">'route'</span>,
                        <span class="hljs-attr">name</span>: message.name,
                        <span class="hljs-attr">to</span>: message.to,
                        <span class="hljs-attr">from</span>: message.path,
                        <span class="hljs-attr">body</span>: message.body,
                        <span class="hljs-attr">cookie</span>: message.cookie
                    }
                    vargs.unshift(message.name)
                    descendant.emit.apply(descendant, vargs)
                    vargs.shift()
                } <span class="hljs-keyword">else</span> {
                    vargs[<span class="hljs-number">0</span>] = {
                        <span class="hljs-attr">module</span>: <span class="hljs-string">'descendant'</span>,
                        <span class="hljs-attr">method</span>: <span class="hljs-string">'route'</span>,
                        <span class="hljs-attr">name</span>: message.name,
                        <span class="hljs-attr">to</span>: message.to.slice(<span class="hljs-number">1</span>),
                        <span class="hljs-attr">from</span>: message.path.slice(),
                        <span class="hljs-attr">path</span>: [],
                        <span class="hljs-attr">body</span>: message.body
                    }
                    descendant._listener.apply(<span class="hljs-literal">null</span>, vargs)
                }
            }
            <span class="hljs-keyword">if</span> (
                message.to[<span class="hljs-number">0</span>] !== descendant.process.pid
            ) {
                vargs[<span class="hljs-number">0</span>] = message
                send(descendant.process, vargs)
            }
        } <span class="hljs-keyword">else</span> {
            vargs[<span class="hljs-number">0</span>] = {
                <span class="hljs-attr">module</span>: <span class="hljs-string">'descendant'</span>,
                <span class="hljs-attr">method</span>: <span class="hljs-string">'up'</span>,
                <span class="hljs-attr">from</span>: [ descendant.process.pid, pid ],
                <span class="hljs-attr">cookie</span>: coalesce(cookie),
                <span class="hljs-attr">body</span>: message
            }
            vargs.unshift(<span class="hljs-string">'up'</span>)
            descendant.emit.apply(descendant, vargs)
        }
    }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">close</span> (<span class="hljs-params">descendant, cookie, child</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">exitCode, signal</span>) </span>{
        assert(!child.connected, <span class="hljs-string">'child is still connected'</span>)
        <span class="hljs-keyword">const</span> listeners = descendant._listeners[child.pid]
        descendant.removeChild(child)</pre></div></div>

        </li>


        <li id="section-5">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Pretend that the child announced it’s own exit.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        listeners.message.call(<span class="hljs-literal">null</span>, {
            <span class="hljs-attr">module</span>: <span class="hljs-string">'descendant'</span>,
            <span class="hljs-attr">method</span>: <span class="hljs-string">'route'</span>,
            <span class="hljs-attr">name</span>: <span class="hljs-string">'descendant:close'</span>,
            <span class="hljs-attr">to</span>: [ <span class="hljs-number">0</span> ],
            <span class="hljs-attr">path</span>: [ child.pid ],
            <span class="hljs-attr">body</span>: { <span class="hljs-attr">exitCode</span>: exitCode, <span class="hljs-attr">signal</span>: signal }
        })
    }
}</pre></div></div>

        </li>


        <li id="section-6">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>TODO Could use <code>-1</code> to mean go up one. <code>0</code> means root. Or else <code>-Infinity</code>
means to the root. No, <code>0</code> because <code>-Infinity</code> is not valid JSON. Overshoot
and it stops at the root.</p>

            </div>

            <div class="content"><div class='highlight'><pre>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Descendant</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">events</span>.<span class="hljs-title">EventEmitter</span> </span>{
    <span class="hljs-keyword">constructor</span> (process) {
        <span class="hljs-keyword">super</span>()
        <span class="hljs-keyword">const</span> descendant = <span class="hljs-keyword">this</span>
        <span class="hljs-keyword">this</span>.process = process
        <span class="hljs-keyword">this</span>.children = {}
        <span class="hljs-keyword">this</span>._listeners = {}
        <span class="hljs-keyword">this</span>._counter = <span class="hljs-number">0</span>
        events.EventEmitter.call(<span class="hljs-keyword">this</span>)
    }

    createMockProcess () {
        <span class="hljs-keyword">const</span> process = <span class="hljs-keyword">new</span> events.EventEmitter
        process.pid = <span class="hljs-number">2</span>
        process.env = { <span class="hljs-string">'DESCENDANT_PROCESS_PATH'</span>: <span class="hljs-string">'1'</span> }
        process.send = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">message, socket</span>) </span>{
            <span class="hljs-keyword">const</span> vargs = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>)
            vargs.unshift(<span class="hljs-string">'descendant:sent'</span>)
            process.emit.apply(process, vargs)
        }
        process.connected = <span class="hljs-literal">true</span>
        <span class="hljs-keyword">this</span>.process = process
    }


    decrement () {
        <span class="hljs-keyword">if</span> (--<span class="hljs-keyword">this</span>._counter == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">this</span>.process.removeListener(<span class="hljs-string">'message'</span>, <span class="hljs-keyword">this</span>._listener)
            <span class="hljs-built_in">Object</span>.keys(<span class="hljs-keyword">this</span>.children).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">pid</span>) </span>{
                <span class="hljs-keyword">this</span>.removeChild(<span class="hljs-keyword">this</span>.children[pid])
            }, <span class="hljs-keyword">this</span>)
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._parentProcessPath == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.process.env.DESCENDANT_PROCESS_PATH
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">this</span>.process.env.DESCENDANT_PROCESS_PATH = <span class="hljs-keyword">this</span>._parentProcessPath
            }
            <span class="hljs-keyword">this</span>.path = <span class="hljs-literal">null</span>
        }
    }

    increment () {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._counter++ == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">this</span>._parentProcessPath = coalesce(<span class="hljs-keyword">this</span>.process.env.DESCENDANT_PROCESS_PATH)
            <span class="hljs-keyword">this</span>.path = coalesce(<span class="hljs-keyword">this</span>._parentProcessPath, <span class="hljs-string">'0'</span>).split(<span class="hljs-regexp">/\s+/</span>).map(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">pid</span>) </span>{
                <span class="hljs-keyword">return</span> +pid
            })
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.path[<span class="hljs-number">0</span>] === <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">this</span>.path = []
            }
            <span class="hljs-keyword">this</span>.path.push(<span class="hljs-keyword">this</span>.process.pid)
            <span class="hljs-keyword">this</span>.process.env.DESCENDANT_PROCESS_PATH = <span class="hljs-keyword">this</span>.path.join(<span class="hljs-string">' '</span>)
            <span class="hljs-keyword">this</span>.process.on(<span class="hljs-string">'message'</span>, <span class="hljs-keyword">this</span>._listener = down(<span class="hljs-keyword">this</span>))
        }
    }

    addMockChild (pid, cookie) {
        <span class="hljs-keyword">const</span> child = <span class="hljs-keyword">new</span> events.EventEmitter
        child.pid = pid
        child.connected = <span class="hljs-literal">true</span>
        child.send = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">const</span> vargs = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>)
            vargs.unshift(<span class="hljs-string">'descendant:sent'</span>)
            <span class="hljs-keyword">this</span>.emit.apply(<span class="hljs-keyword">this</span>, vargs)
        }
        <span class="hljs-keyword">this</span>.addChild(child, cookie)
        <span class="hljs-keyword">return</span> child
    }

    addChild (child, cookie) {
        <span class="hljs-keyword">this</span>.children[child.pid] = child
        <span class="hljs-keyword">const</span> listeners = <span class="hljs-keyword">this</span>._listeners[child.pid] = {
            <span class="hljs-attr">message</span>: up(<span class="hljs-keyword">this</span>,  cookie, child.pid),
            <span class="hljs-attr">close</span>: close(<span class="hljs-keyword">this</span>, cookie, child)
        }
        child.on(<span class="hljs-string">'message'</span>, listeners.message)
        child.on(<span class="hljs-string">'close'</span>, listeners.close)

    }

    removeChild (child) {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Number</span>.isInteger(child)) {
            child = <span class="hljs-keyword">this</span>.children[child]
        }
        <span class="hljs-keyword">const</span> listeners = <span class="hljs-keyword">this</span>._listeners[child.pid]
        <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>.children[child.pid]
        <span class="hljs-keyword">delete</span> <span class="hljs-keyword">this</span>._listeners[child.pid]
        child.removeListener(<span class="hljs-string">'message'</span>, listeners.message)
        child.removeListener(<span class="hljs-string">'close'</span>, listeners.close)
    }

    up (to, name, message) {
        <span class="hljs-keyword">const</span> vargs = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">2</span>)
        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">Array</span>.isArray(to)) {
            to = [ to ]
        }
        assert(to[<span class="hljs-number">0</span>] !== <span class="hljs-number">0</span> || vargs.length === <span class="hljs-number">1</span>, <span class="hljs-string">'cannot broadcast a handle'</span>)
        vargs[<span class="hljs-number">0</span>] = {
            <span class="hljs-attr">module</span>: <span class="hljs-string">'descendant'</span>,
            <span class="hljs-attr">method</span>: <span class="hljs-string">'route'</span>,
            <span class="hljs-attr">name</span>: name,
            <span class="hljs-attr">to</span>: to,
            <span class="hljs-attr">path</span>: [ <span class="hljs-keyword">this</span>.process.pid ],
            <span class="hljs-attr">body</span>: message
        }
        send(<span class="hljs-keyword">this</span>.process, vargs)
    }</pre></div></div>

        </li>


        <li id="section-7">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Send a message down to a child. Path is the full path to the child with
an entry for each process in the path to the child, so that we are able
to address children of children and their children and so on. The <code>name</code>
is the name of the event emitted on the <code>Descendant</code> object in the child.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    down (path, name, message) {
        <span class="hljs-keyword">const</span> vargs = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">2</span>)
        <span class="hljs-keyword">const</span> envelope = vargs[<span class="hljs-number">0</span>] = {
            <span class="hljs-attr">module</span>: <span class="hljs-string">'descendant'</span>,
            <span class="hljs-attr">method</span>: <span class="hljs-string">'route'</span>,
            <span class="hljs-attr">name</span>: name,
            <span class="hljs-attr">to</span>: path.slice(),
            <span class="hljs-attr">from</span>: [ <span class="hljs-keyword">this</span>.process.pid ],
            <span class="hljs-attr">path</span>: [],
            <span class="hljs-attr">body</span>: message
        }
        <span class="hljs-keyword">if</span> (envelope.to[<span class="hljs-number">0</span>] == <span class="hljs-keyword">this</span>.process.pid) {
            envelope.to.shift()
        }
        <span class="hljs-keyword">this</span>._listener.apply(<span class="hljs-literal">null</span>, vargs)
    }</pre></div></div>

        </li>


        <li id="section-8">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Useful for unit testing, sending a message across means sending it
directly. We can’t just use <code>down</code> nor <code>up</code> because they will remove a
reference to self as a convenience.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    across (name, message) {
        <span class="hljs-keyword">const</span> vargs = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>)
        <span class="hljs-keyword">const</span> envelope = vargs[<span class="hljs-number">0</span>] = {
            <span class="hljs-attr">module</span>: <span class="hljs-string">'descendant'</span>,
            <span class="hljs-attr">method</span>: <span class="hljs-string">'route'</span>,
            <span class="hljs-attr">name</span>: name,
            <span class="hljs-attr">from</span>: [],
            <span class="hljs-attr">to</span>: [],
            <span class="hljs-attr">path</span>: [],
            <span class="hljs-attr">body</span>: message
        }
        vargs.unshift(<span class="hljs-string">'message'</span>)
        <span class="hljs-keyword">this</span>.process.emit.apply(<span class="hljs-keyword">this</span>.process, vargs)
    }
}

<span class="hljs-built_in">module</span>.exports = Descendant</pre></div></div>

        </li>

    </ul>
  </div>
</body>
</html>
